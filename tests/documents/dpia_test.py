from gdpr_rag.documents.dpia import DPIA

import sys
sys.path.append('E:/Code/chat/gdpr')


def test_regression():
    path_to_manual_as_csv_file = "./inputs/documents/dpia.parquet"

    doc = DPIA(path_to_manual_as_csv_file)
    section = "I"
    assert doc.get_heading(section) == 'I Introduction'
    assert doc.get_text(section, add_markdown_decorators = False) == 'I Introduction\nRegulation 2016/679[^1] (GDPR) will apply from 25 May 2018. Article 35 of the GDPR introduces the concept of a Data Protection Impact Assessment (DPIA[^2]), as does Directive 2016/680[^3].\nA DPIA is a process designed to describe the processing, assess its necessity and proportionality and help manage the risks to the rights and freedoms of natural persons resulting from the processing of personal data[^4] by assessing them and determining the measures to address them. DPIAs are important tools for accountability, as they help controllers not only to comply with requirements of the GDPR, but also to demonstrate that appropriate measures have been taken to ensure compliance with the Regulation (see also article 24)[^5]. In other words, a DPIA is a process for building and demonstrating compliance.\nUnder the GDPR, non-compliance with DPIA requirements can lead to fines imposed by the competent supervisory authority. Failure to carry out a DPIA when the processing is subject to a DPIA (Article 35(1) and (3)-(4)), carrying out a DPIA in an incorrect way (Article 35(2) and (7) to (9)), or failing to consult the competent supervisory authority where required (Article 36(3)(e)), can result in an administrative fine of up to 10M€, or in the case of an undertaking, up to 2 % of the total worldwide annual turnover of the preceding financial year, whichever is higher.\n\n  \n[^1]: Regulation (EU) 2016/679 of the European Parliament and of the Council of 27 April 2016 on the protection of natural persons with regard to the processing of personal data and on the free movement of such data, and repealing Directive 95/46/EC (General Data Protection Regulation).  \n[^2]: The term "Privacy Impact Assessment" (PIA) is often used in other contexts to refer to the same concept.  \n[^3]: Article 27 of the Directive (EU) 2016/680 of the European Parliament and of the Council of 27 April 2016 on the protection of natural persons with regard to the processing of personal data by competent authorities for the purposes of the prevention, investigation, detection or prosecution of criminal offences or the execution of criminal penalties, and on the free movement of such data, also states that a privacy impact assessment is needed for "the processing is likely to result in a high risk to the rights and freedoms of natural persons".  \n[^4]: The GDPR does not formally define the concept of a DPIA as such, but <ul><li> its minimal content is specified by Article 35(7) as follows: <ol type="a"> <li> systematic description of the envisaged processing operations and the purposes of the processing, including, where applicable, the legitimate interest pursued by the controller; </li><li> an assessment of the necessity and proportionality of the processing operations in relation to the purposes; </li><li> an assessment of the risks to the rights and freedoms of data subjects referred to in paragraph 1; and </li><li> the measures envisaged to address the risks, including safeguards, security measures and mechanisms to ensure the protection of personal data and to demonstrate compliance with this Regulation taking into account the rights and legitimate interests of data subjects and other persons concerned;</ol></li><li> its meaning and role is clarified by recital 84 as follows: "In order to enhance compliance with this Regulation where processing operations are likely to result in a high risk to the rights and freedoms of natural persons, the controller should be responsible for the carrying-out of a data protection impact assessment to evaluate, in particular, the origin, nature, particularity and severity of that risk". </li></ul>  \n[^5]: See also recital 84: "The outcome of the assessment should be taken into account when determining the appropriate measures to be taken in order to demonstrate that the processing of personal data complies with this Regulation".'


    section = 'Annex 1'
    assert doc.get_heading(section) == 'Annex 1 Examples of existing EU DPIA frameworks'
    assert doc.get_text(section, add_markdown_decorators = False) == "Annex 1 Examples of existing EU DPIA frameworks\nThe GDPR does not specify which DPIA process must be followed but instead allows for data controllers to introduce a framework which complements their existing working practices provided it takes account of the components described in Article 35(7). Such a framework can be bespoke to the data controller or common across a particular industry. Previously published frameworks developed by EU DPAs and EU sector-specific frameworks include (but are not limited to):\nExamples of EU generic frameworks:\n- DE: Standard Data Protection Model, V.1.0 -  Trial version, 2016[^31]. https://www.datenschutzzentrum.de/uploads/SDM-Methodology_V1_EN1.pdf\n- ES: Guía para una Evaluación de Impacto en la Protección de Datos Personales (EIPD), Agencia española de protección de datos (AGPD), 2014. https://www.agpd.es/portalwebAGPD/canaldocumentacion/publicaciones/common/Guias/Gui a_EIPD.pdf\n- FR: Privacy Impact Assessment (PIA), Commission nationale de l'informatique et des libertés (CNIL), 2015. https://www.cnil.fr/fr/node/15798\n- UK: Conducting privacy impact assessments code of practice, Information Commissioner's Office (ICO), 2014. https://ico.org.uk/media/for-organisations/documents/1595/pia-code-of-practice.pdf\nExamples of EU sector-specific frameworks:\n- Privacy and Data Protection Impact Assessment Framework for RFID Applications[^32]. http://ec.europa.eu/justice/data-protection/article-29/documentation/opinion- recommendation/files/2011/wp180_annex_en.pdf\n- Data Protection Impact Assessment Template for Smart Grid and Smart Metering systems[^33] http://ec.europa.eu/energy/sites/ener/files/documents/2014_dpia_smart_grids_forces.pdf An international standard will also provide guidelines for methodologies used for carrying out a DPIA (ISO/IEC 29134[^34]).\n\n  \n[^31]: Unanimously and affirmatively acknowledged (under abstention of Bavaria) by the 92. Conference of the Independent Data Protection Authorities of the Bund and the Länder in Kühlungsborn on 9-10 November 2016.  \n[^32]: See also : - Commission Recommendation of 12 May 2009 on the implementation of privacy and data protection principles in applications supported by radio- frequency identification. https://ec.europa.eu/digital-single-market/en/news/commission-recommendation-12-may-2009- implementation-privacy-and-data-protection-principles - Opinion 9/2011 on the revised Industry Proposal for a Privacy and Data Protection Impact Assessment Framework for RFID Applications. http://ec.europa.eu/justice/data-protection/article-29/documentation/opinion- recommendation/files/2011/wp180_en.pdf  \n[^33]: See also the Opinion 07/2013 on the Data Protection Impact Assessment Template for Smart Grid and Smart Metering Systems ('DPIA Template') prepared by Expert Group 2 of the Commission's Smart Grid Task Force. http://ec.europa.eu/justice/data-protection/article-29/documentation/opinion- recommendation/files/2013/wp209_en.pdf  \n[^34]: ISO/IEC 29134 (project), Information technology - Security techniques - Privacy impact assessment - Guidelines, International Organization for Standardization (ISO)."

    
    # Special case for section IV
    section = "IV"
    assert doc.get_heading(section) == 'IV Conclusions and recommendations'
    assert doc.get_text(section, add_markdown_decorators = False) == 'IV Conclusions and recommendations\nDPIAs are a useful way for data controllers to implement data processing systems that comply with the GDPR and can be mandatory for some types of processing operations. They are scalable and can take different forms, but the GDPR sets out the basic requirements of an effective DPIA. Data controllers should see the carrying out of a DPIA as a useful and positive activity that aids legal compliance.\nArticle 24(1) sets out the basic responsibility of the controller in terms of complying with the GDPR: "taking into account the nature, scope, context and purposes of processing as well as the risks of varying likelihood and severity for the rights and freedoms of natural persons, the controller shall implement appropriate technical and organisational measures to ensure and to be able to demonstrate that processing is performed in accordance with this Regulation. Those measures shall be reviewed and updated where necessary".\nThe DPIA is a key part of complying with the Regulation where high risk data processing is planned or is taking place. This means that data controllers should use the criteria set out in this document to determine whether or not a DPIA has to be carried out. Internal data controller policy could extend this list beyond the GDPR\'s legal requirements. This should result in greater trust and confidence of data subjects and other data controllers.\nWhere a likely high risk processing is planned, the data controller must:\n- choose a DPIA methodology (examples given in Annex 1) that satisfies the criteria in Annex 2, or specify and implement a systematic DPIA process that:\n- is compliant with the criteria in Annex 2;\n- is integrated into existing design, development, change, risk and operational review processes in accordance with internal processes, context and culture;\n- involves the appropriate interested parties and clearly define their responsibilities (controller, DPO, data subjects or their representatives, business, technical services, processors, information security officer, etc.);\n- provide the DPIA report to the competent supervisory authority when required to do so;\n- consult the supervisory authority when they have failed to determine sufficient measures to mitigate the high risks;\n- periodically review the DPIA and the processing it assesses, at least when there is a change of the risk posed by processing the operation;\n- document the decisions taken.'


    
